<% request_helper = RequestHelper.new(request) %>
<% sort_url_builder = ->(key, dir) { request_helper.url_with_query({ sort: key, sort_dir: dir, page: 1 }, []) } %>

<%= turbo_frame_tag "game_servers" do %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0"><%= t("admin.games.show.servers") %></h5>
    </div>
    <div class="card-body">
      <div class="admin-pagination-search-row mb-3">
        <div class="admin-pagination-search-row__pagination">
          <%= render(PaginationComponent.new(@pagination, align: :start)) %>
        </div>
        <%= form_with(
          method: :get,
          url: servers_admin_game_path(@game),
          class: "d-flex align-items-center gap-2 flex-wrap admin-servers-filter-inline",
          html: { "aria-label": t("admin.servers.index.filter.title") },
          data: {
            controller: "admin-filter",
            action: "change->admin-filter#filter"
          }
        ) do |form| %>
          <%= render(Admin::ServersFilterComponent.new(
            form: form,
            selected_value_status: @filter_status,
            selected_value_country_code: @filter_country_code,
            request: request
          )) %>
        <% end %>
        <%= render(Admin::SearchFormComponent.new(
          url: servers_admin_game_path(@game),
          search_term: @search_term,
          placeholder: t("admin.servers.index.search_placeholder"),
          hidden_params: params.permit(:status, :country_code, :sort, :sort_dir).to_h.compact
        )) %>
      </div>

      <%=
        render(Admin::TableComponent.new(
          collection: @servers,
          empty_message: t("admin.servers.index.empty_message"),
          sort_column: @sort_column,
          sort_direction: @sort_direction,
          sort_url_builder: sort_url_builder,
          columns: [
            [
              t("admin.shared.id"),
              -> { link_to(it.id, admin_server_path(it), class: "fw-medium", data: { turbo_frame: "_top" }) },
              { copyable: :id, sortable: "id" },
            ],
            [
              Server.human_attribute_name(:name),
              -> { it.name.presence },
              { copyable: :name, sortable: "name" },
            ],
            [
              Server.human_attribute_name(:site_url),
              -> { link_to(truncate(it.site_url, length: 35), it.site_url, target: "_blank", rel: "noopener noreferrer", class: "text-break") },
              { copyable: :site_url, sortable: "site_url" },
            ],
            [
              Server.human_attribute_name(:country),
              -> { it.country&.iso_short_name || it.country_code },
              { copyable: ->(it) { it.country&.iso_short_name || it.country_code }, sortable: "country" },
            ],
            [
              t("admin.admin_sessions.columns.status"),
              -> { render(Admin::ServerStatusBadgesComponent.new(server: it)) },
              { sortable: "status" },
            ],
            [
              t("admin.shared.actions"),
              -> {
                render(Admin::IndexActionsComponent.new(
                  view_path: admin_server_path(it),
                  edit_path: edit_admin_server_path(it),
                  extra_actions: [{ path: server_path(it), label: t("admin.servers.edit_actions.public"), target: "_blank", rel: "noopener noreferrer" }],
                  link_options: { data: { turbo_frame: "_top" } },
                ))
              },
            ],
          ],
        ))
      %>

      <%= render(PaginationComponent.new(@pagination, align: :start)) %>
    </div>
  </div>
<% end %>
